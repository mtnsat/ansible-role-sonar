---
- set_fact:
    sonar_previous_version: "{{ sonar_application_other_version.files[0].path | regex_replace('^/usr/local/sonar/lib/sonar-application-(.*).jar$', '\\1') }}"

- name: Ensure Sonar is stopped.
  service:
    name: sonar
    state: stopped

- name: Ensure previous version {{ sonar_previous_version }} is deleted.
  file:
    path: '/usr/local/sonar/'
    state : absent
  when: not sonar_previous_version_backup

- name: Ensure previous version {{ sonar_previous_version }} directory is present.
  file:
    path: "/usr/local/sonar-{{ sonar_previous_version }}"
    state: directory
  when: sonar_previous_version_backup

- name: Ensure previous version {{ sonar_previous_version }} is moved apart.
  shell: >
    mv /usr/local/sonar/* /usr/local/sonar-{{ sonar_previous_version }}
    creates=/usr/local/sonar-{{ sonar_previous_version }}/lib/sonar-application-{{ sonar_previous_version }}.jar
  when: sonar_previous_version_backup
